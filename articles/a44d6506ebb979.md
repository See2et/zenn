---
title: "[home-manager]codexがError: Permission denied (os error 13)を吐く問題への対処法"
emoji: "🌟"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["nix", "codex"]
published: false
---

## Abstract
Nixの[home-manager](https://github.com/nix-community/home-manager)を用いたパッケージ管理環境へ移行していたところ、codexが正常に動作しませんでした。

## 起きていた問題

home-managerでは、宣言的にパッケージを管理することが出来ます。それに倣い、codexを以下のようにインストールしました。
```nix:home.nix
{config, pkgs}: {
    ...
    home.packages = pkgs; [
        neovim
        zsh
        ...
        codex
    ]
    ...
}
```
```zsh:zsh
// home.nixの変更を反映するコマンド
$ home-manager switch
```

しかし、codexを正常に動作させることが出来ませんでした。
```zsh:zsh
$ codex
Error: Permission denied (os error 13)
```

## 問題の切り分け
まず、`codex`コマンドそれ自体が正常に動作していないのか、それ以外のread/writeが必要な場面で詰まっているのかを切り分けます。幸か不幸か`codex --help`は正常に動作しました。
```zsh:zsh
$ codex --help
Codex CLI

If no subcommand is specified, options will be forwarded to the interactive CLI.

Usage: codex [OPTIONS] [PROMPT]
       codex [OPTIONS] [PROMPT] <COMMAND>
...
```

codexは`~/.codex`配下にログ等を読み書きするので、ここの権限不足を疑います。どうやら、書き込みが禁止されていることが分かります。

```zsh:zsh
$ cd ~/.codex
$ lsd -la
dr-xr-xr-x   2 see2et see2et 4.0K Jan  1  1970 .
drwxr-xr-x 517 see2et see2et 356K Oct  1 04:53 ..
-r--r--r--   1 see2et see2et  145 Jan  1  1970 AGENTS.md
-r--r--r--   1 see2et see2et  504 Jan  1  1970 config.toml
-r--r--r--   1 see2et see2et  395 Jan  1  1970 github-mcp.sh
```

`chmod 700 .`とかで権限を与えてもいいのですが......これは、宣言的になるべく全てを扱いたいNixの思想に反するので、お作法的に避けたいところです。なので、根本的な原因を解決することにしました。

## 原因の正体
`~/.codex`がreadonlyになっていた原因は、以下のようにcodexの設定ファイルを管理していたことにありました。この設定により、`home-manager switch`実行時に`~/.config/home-manager/codex`は`~/.codex`に自動で配置されます。
```nix:home.nix
{config, pkgs}: {
    home.file = {
        ".config/nvim".source = ./nvim;
        ".config/zellij".source = ./zellij;
        ...
        ".codex".source = ./codex;
    };
}
```
このとき、home-managerはファイル群をreadonlyで配置するようです。そこで、必要なファイルだけをhome-managerで配置することで、この問題を解決しました。
```diff:home.nix
{config, pkgs}: {
    home.file = {
        ".config/nvim".source = ./nvim;
        ".config/zellij".source = ./zellij;
        ...
-   ".codex".source = ./codex;

+   # 必要なファイルだけを配る（親ディレクトリは実体として作られる）
+   ".codex/config.toml".source = ./codex/config.toml;
+   ".codex/AGENTS.md".source = ./codex/AGENTS.md;
+   ".codex/github-mcp.sh" = {
+       source = ./codex/github-mcp.sh;
+       executable = true;
+   };
}
```
